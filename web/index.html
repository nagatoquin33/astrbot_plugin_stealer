<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¨åˆ©çš„æˆ˜åˆ©å“</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .emoji-card:hover .overlay {
            opacity: 1;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8 animate-fade-in-up">
            <div class="glass rounded-3xl shadow-2xl p-8 border border-white/20">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-4xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                            ğŸ† äº¨åˆ©çš„æˆ˜åˆ©å“
                        </h1>
                        <p class="text-gray-600 text-sm">ç²¾å¿ƒæ”¶è—çš„è¡¨æƒ…åŒ…å®åº“</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-purple-600">{{ stats.total_images }}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide">æ€»æ”¶è—</div>
                    </div>
                </div>
                
                <!-- Categories Stats -->
                <div class="flex flex-wrap gap-2 mt-4">
                    <div v-for="(count, cat) in stats.categories" :key="cat" 
                         class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 border border-purple-200 hover:shadow-md transition">
                        <span class="text-xs font-medium text-purple-700">{{ cat }}</span>
                        <span class="text-xs font-bold text-purple-900 bg-white/60 px-2 py-0.5 rounded-full">{{ count }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Controls -->
        <div class="glass p-6 rounded-2xl shadow-xl mb-8 sticky top-4 z-20 border border-white/20 animate-fade-in-up">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search -->
                <div class="flex-1 relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <input type="text" v-model="searchQuery" @input="debouncedSearch"
                           placeholder="æœç´¢è¡¨æƒ…åŒ… (æ ‡ç­¾ã€æè¿°)..." 
                           class="w-full pl-12 pr-4 py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition bg-white/80">
                </div>
                <!-- Category Filter -->
                <div class="flex-none">
                    <select v-model="selectedCategory" @change="fetchImages(1)"
                            class="w-full md:w-56 px-4 py-3 border-2 border-purple-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none bg-white/80 cursor-pointer transition">
                        <option value="">ğŸ“‚ æ‰€æœ‰åˆ†ç±»</option>
                        <option v-for="(count, cat) in stats.categories" :key="cat" :value="cat">
                            {{ cat }} ({{ count }})
                        </option>
                    </select>
                </div>
                <!-- Refresh -->
                <button @click="fetchImages(1)" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 transition shadow-lg hover:shadow-xl font-medium">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- Gallery -->
        <div v-if="loading" class="text-center py-20">
            <div class="inline-block">
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600 mx-auto"></div>
                <p class="mt-6 text-gray-600 font-medium">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div v-else-if="images.length === 0" class="text-center py-20">
            <div class="glass rounded-2xl p-12 inline-block">
                <div class="text-6xl mb-4">ğŸ”</div>
                <p class="text-gray-500 text-lg">æ²¡æœ‰æ‰¾åˆ°è¡¨æƒ…åŒ…</p>
            </div>
        </div>

        <div v-else class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-5">
            <div v-for="(img, idx) in images" :key="img.hash"
                 class="emoji-card group glass rounded-2xl shadow-lg overflow-hidden border border-white/40 hover-lift hover:shadow-2xl transition-all flex flex-col">
                <!-- å›¾ç‰‡åŒºåŸŸ -->
                <div class="w-full aspect-square relative cursor-zoom-in overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100"
                     @click="openPreview(img, idx)" title="ç‚¹å‡»æ”¾å¤§">
                    <img :src="img.url" :alt="img.desc"
                         class="w-full h-full object-contain p-3 transition-all duration-300 group-hover:scale-110 group-hover:rotate-2"
                         loading="lazy">
                    
                    <!-- å·¦ä¸Šè§’åˆ†ç±»æ ‡ç­¾ -->
                    <div class="absolute top-3 left-3 pointer-events-none">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg backdrop-blur-sm">
                            {{ img.category }}
                        </span>
                    </div>

                    <!-- å³ä¸Šè§’åˆ é™¤æŒ‰é’® -->
                    <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <button @click.stop="deleteImage(img)" 
                                class="bg-white/95 hover:bg-red-50 text-red-500 rounded-full p-2 shadow-lg border border-red-100 hover:border-red-300 transition backdrop-blur-sm hover:scale-110" 
                                title="åˆ é™¤">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-1 1-1h6c1 0 1 1 1 1v2"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- æ‚¬æµ®é®ç½©æç¤º -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                </div>

                <!-- åº•éƒ¨ä¿¡æ¯æ¡ -->
                <div class="p-4 flex-1 flex flex-col justify-between bg-white/80">
                    <p class="text-xs text-gray-700 line-clamp-2 mb-2 min-h-[2.5em] leading-relaxed" :title="img.desc || 'æ— æè¿°'">
                        {{ img.desc || 'ï¼ˆæ— æè¿°ï¼‰' }}
                    </p>
                    <div class="flex flex-wrap gap-1.5 content-end">
                        <span v-for="tag in (img.tags || []).slice(0, 3)" :key="tag"
                              class="text-[10px] bg-gradient-to-r from-purple-50 to-pink-50 text-purple-700 border border-purple-200 px-2 py-1 rounded-full font-medium">
                            #{{ tag }}
                        </span>
                        <span v-if="(img.tags || []).length > 3" class="text-[10px] text-gray-400 px-1 py-1">+{{ (img.tags || []).length - 3 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="mt-10 flex justify-center items-center gap-3 animate-fade-in-up">
            <button @click="prevPage" :disabled="currentPage === 1" 
                    class="px-6 py-3 glass border border-white/40 rounded-xl hover:bg-white/60 disabled:opacity-40 disabled:cursor-not-allowed transition shadow-md font-medium">
                â† ä¸Šä¸€é¡µ
            </button>
            <div class="glass px-6 py-3 rounded-xl text-gray-700 font-medium border border-white/40 shadow-md">
                ç¬¬ <span class="text-purple-600 font-bold">{{ currentPage }}</span> é¡µ / å…± <span class="text-purple-600 font-bold">{{ Math.ceil(total / pageSize) }}</span> é¡µ
            </div>
            <button @click="nextPage" :disabled="currentPage * pageSize >= total"
                    class="px-6 py-3 glass border border-white/40 rounded-xl hover:bg-white/60 disabled:opacity-40 disabled:cursor-not-allowed transition shadow-md font-medium">
                ä¸‹ä¸€é¡µ â†’
            </button>
        </div>

        <!-- Preview Modal -->
        <div v-if="previewOpen" class="fixed inset-0 z-50 animate-fade-in-up">
            <!-- backdrop -->
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="closePreview"></div>
            <!-- content -->
            <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-6xl rounded-3xl shadow-2xl overflow-hidden border-4 border-white/20">
                    <div class="flex flex-col md:flex-row">
                        <!-- image -->
                        <div class="md:w-2/3 bg-gradient-to-br from-gray-50 to-gray-100 relative flex items-center justify-center p-8">
                            <img v-if="previewItem" :src="previewItem.url" :alt="previewItem.desc"
                                 class="w-full h-[60vh] md:h-[80vh] object-contain drop-shadow-2xl" />

                            <!-- nav buttons -->
                            <button @click="prevPreview" :disabled="previewIndex <= 0"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 glass hover:bg-white text-gray-800 rounded-full w-12 h-12 flex items-center justify-center shadow-xl disabled:opacity-30 disabled:cursor-not-allowed border-2 border-white/40 hover:scale-110 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <button @click="nextPreview" :disabled="previewIndex >= images.length - 1"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 glass hover:bg-white text-gray-800 rounded-full w-12 h-12 flex items-center justify-center shadow-xl disabled:opacity-30 disabled:cursor-not-allowed border-2 border-white/40 hover:scale-110 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        </div>

                        <!-- meta -->
                        <div class="md:w-1/3 p-6 flex flex-col gap-5 bg-gradient-to-br from-purple-50 to-pink-50">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-2">åˆ†ç±»æ ‡ç­¾</div>
                                    <div class="flex items-center gap-3">
                                        <span class="inline-flex px-4 py-2 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm font-bold shadow-lg">
                                            {{ previewItem?.category || 'unknown' }}
                                        </span>
                                        <span class="text-sm text-gray-500 font-medium">{{ previewIndex + 1 }} / {{ images.length }}</span>
                                    </div>
                                </div>
                                <button @click="closePreview" class="glass hover:bg-red-50 text-gray-600 hover:text-red-600 rounded-full w-10 h-10 flex items-center justify-center transition border border-white/40 hover:border-red-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>

                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-4 border border-white/60">
                                <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-2">æè¿°ä¿¡æ¯</div>
                                <div class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap break-words">
                                    {{ previewItem?.desc || 'ï¼ˆæ— æè¿°ï¼‰' }}
                                </div>
                            </div>

                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-4 border border-white/60">
                                <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-3">ç›¸å…³æ ‡ç­¾</div>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="tag in (previewItem?.tags || [])" :key="tag"
                                          class="text-xs bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 px-3 py-1.5 rounded-full font-medium border border-purple-200">#{{ tag }}</span>
                                    <span v-if="(previewItem?.tags || []).length === 0" class="text-sm text-gray-400">ï¼ˆæ— æ ‡ç­¾ï¼‰</span>
                                </div>
                            </div>

                            <div class="pt-3 flex flex-col gap-3">
                                <a v-if="previewItem" :href="previewItem.url" target="_blank" rel="noreferrer"
                                   class="w-full text-center px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                                    ğŸ“¥ æ‰“å¼€/ä¸‹è½½å›¾ç‰‡
                                </a>
                                <button @click="deleteImage(previewItem)" class="w-full px-5 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                                    ğŸ—‘ï¸ åˆ é™¤è¿™å¼ 
                                </button>
                            </div>

                            <div class="text-xs text-gray-500 pt-2 text-center bg-white/40 rounded-xl p-3 border border-white/60">
                                ğŸ’¡ å¿«æ·é”®ï¼š<kbd class="px-2 py-1 bg-white rounded shadow-sm font-mono">Esc</kbd> å…³é—­ Â· 
                                <kbd class="px-2 py-1 bg-white rounded shadow-sm font-mono">â†</kbd>
                                <kbd class="px-2 py-1 bg-white rounded shadow-sm font-mono">â†’</kbd> åˆ‡æ¢
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    images: [],
                    stats: { total_images: 0, categories: {} },
                    loading: false,
                    searchQuery: '',
                    selectedCategory: '',
                    currentPage: 1,
                    pageSize: 24,
                    total: 0,
                    searchTimeout: null,

                    // é¢„è§ˆå¼¹çª—
                    previewOpen: false,
                    previewItem: null,
                    previewIndex: -1
                }
            },
            mounted() {
                this.fetchStats();
                this.fetchImages();

                // é”®ç›˜å¿«æ·é”®ï¼ˆé¢„è§ˆæ›´é¡ºæ‰‹ï¼‰
                window.addEventListener('keydown', this.onKeydown);
            },
            unmounted() {
                window.removeEventListener('keydown', this.onKeydown);
            },
            methods: {
                openPreview(img, idx) {
                    this.previewItem = img;
                    this.previewIndex = idx;
                    this.previewOpen = true;
                },
                closePreview() {
                    this.previewOpen = false;
                    this.previewItem = null;
                    this.previewIndex = -1;
                },
                prevPreview() {
                    if (this.previewIndex > 0) {
                        const idx = this.previewIndex - 1;
                        this.openPreview(this.images[idx], idx);
                    }
                },
                nextPreview() {
                    if (this.previewIndex < this.images.length - 1) {
                        const idx = this.previewIndex + 1;
                        this.openPreview(this.images[idx], idx);
                    }
                },
                onKeydown(e) {
                    if (!this.previewOpen) return;
                    if (e.key === 'Escape') {
                        this.closePreview();
                    } else if (e.key === 'ArrowLeft') {
                        this.prevPreview();
                    } else if (e.key === 'ArrowRight') {
                        this.nextPreview();
                    }
                },
                async fetchStats() {
                    try {
                        const res = await fetch('/api/stats');
                        this.stats = await res.json();
                    } catch (e) {
                        console.error(e);
                    }
                },
                async fetchImages(page = this.currentPage) {
                    this.loading = true;
                    this.currentPage = page;
                    try {
                        const params = new URLSearchParams({
                            page: page,
                            size: this.pageSize,
                            q: this.searchQuery,
                        });
                        if (this.selectedCategory) {
                            params.append('category', this.selectedCategory);
                        }
                        
                        const res = await fetch(`/api/images?${params}`);
                        const data = await res.json();
                        this.images = data.images;
                        this.total = data.total;

                        // è‹¥é¢„è§ˆæ‰“å¼€ï¼Œåˆ·æ–°åå°½é‡ä¿æŒå½“å‰é¢„è§ˆé¡¹
                        if (this.previewOpen && this.previewItem) {
                            const idx = this.images.findIndex(x => x.hash === this.previewItem.hash);
                            if (idx >= 0) {
                                this.openPreview(this.images[idx], idx);
                            } else {
                                this.closePreview();
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        alert('åŠ è½½å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                debouncedSearch() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.fetchImages(1);
                    }, 500);
                },
                async deleteImage(img) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ è¡¨æƒ…åŒ…å—ï¼Ÿ')) return;
                    
                    try {
                        const res = await fetch(`/api/images/${img.hash}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            if (this.previewOpen && this.previewItem && this.previewItem.hash === img.hash) {
                                this.closePreview();
                            }
                            this.fetchImages(this.currentPage);
                            this.fetchStats();
                        } else {
                            alert('åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('åˆ é™¤å‡ºé”™');
                    }
                },
                prevPage() {
                    if (this.currentPage > 1) {
                        this.fetchImages(this.currentPage - 1);
                    }
                },
                nextPage() {
                    if (this.currentPage * this.pageSize < this.total) {
                        this.fetchImages(this.currentPage + 1);
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
